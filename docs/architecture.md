# AUTOSAR 設計ドキュメント

## システム概要

このプロジェクトは、AUTOSAR準拠のリアルタイムOS「Trampoline」をRaspberry Pi上で動作させ、UART通信を通じてPCと連携するシステムです。

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    PC (Windows/Linux)                   │
│  ┌───────────────────────────────────────────────────┐  │
│  │  serial_monitor.py (Python)                       │  │
│  │  - シリアル受信監視                                │  │
│  │  - メッセージ送信                                  │  │
│  │  - ログ表示                                        │  │
│  └───────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────┘
                         │ USB-Serial
                         │ (115200bps)
┌────────────────────────┴────────────────────────────────┐
│              Raspberry Pi (ARM Cortex-A)                │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Trampoline AUTOSAR OS                            │  │
│  │  ┌──────────────────────────────────────────────┐ │  │
│  │  │  TaskSerial (Priority 10, 1000ms cycle)      │ │  │
│  │  │  - 周期的なシリアル送信                       │ │  │
│  │  │  - システム稼働時間の通知                     │ │  │
│  │  └──────────────────────────────────────────────┘ │  │
│  │  ┌──────────────────────────────────────────────┐ │  │
│  │  │  TaskBlink (Priority 5, 500ms cycle)         │ │  │
│  │  │  - LED点滅（動作確認用）                      │ │  │
│  │  └──────────────────────────────────────────────┘ │  │
│  │  ┌──────────────────────────────────────────────┐ │  │
│  │  │  TaskProcess (Priority 8, Event-driven)      │ │  │
│  │  │  - 受信データ処理                             │ │  │
│  │  │  - エコーバック                               │ │  │
│  │  └──────────────────────────────────────────────┘ │  │
│  │  ┌──────────────────────────────────────────────┐ │  │
│  │  │  IsrUartRx (Priority 20)                     │ │  │
│  │  │  - UART受信割り込み                           │ │  │
│  │  │  - データバッファリング                       │ │  │
│  │  └──────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  UART Driver (uart_comm.c)                        │  │
│  │  - UART0 (BCM2835)                                │  │
│  │  - GPIO14/15制御                                  │  │
│  │  - 送受信FIFO管理                                 │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  GPIO Driver                                      │  │
│  │  - LED制御 (GPIO17)                               │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## AUTOSAR構成

### OS設定 (app.oil)

**OS Type:** EXTENDED  
**Scheduling:** FULL_PREEMPTIVE

**特徴:**
- 複数の優先度レベル
- イベント駆動タスク対応
- リソース排他制御
- 割り込み管理

### タスク構成

| タスク名 | 優先度 | 周期 | 説明 |
|---------|--------|------|------|
| TaskSerial | 10 | 1000ms | シリアル送信タスク |
| TaskBlink | 5 | 500ms | LED点滅タスク |
| TaskProcess | 8 | イベント駆動 | データ処理タスク |

### イベント

- **EvtDataReady**: UART受信完了イベント（TaskProcessをトリガー）

### リソース

- **ResUart**: UART排他制御用リソース
  - 複数タスクからの同時アクセスを防止
  - Priority Ceiling Protocol

### 割り込み

- **IsrUartRx**: UART受信割り込み (Category 2)
  - 受信データをバッファに格納
  - TaskProcessを起動

### アラーム/カウンタ

- **SystemCounter**: 1msチック、システムタイマーベース
- **AlarmSerial**: TaskSerialを1秒周期で起動
- **AlarmBlink**: TaskBlinkを500ms周期で起動

## タイミングダイアグラム

```
時刻(ms)   0    500   1000  1500  2000  2500  3000
           │     │     │     │     │     │     │
TaskSerial │     │     ▓     │     ▓     │     ▓
           │     │     │     │     │     │     │
TaskBlink  │     ▓     │     ▓     │     ▓     │
           │     │     │     │     │     │     │
TaskProcess│ (イベント発生時に実行)              │
           │     │     │     │     │     │     │

▓: タスク実行
```

## メモリマップ

```
0x00000000 - 0x00007FFF : ブートROM (未使用)
0x00008000 - 0x000FFFFF : Code (.text)
0x00100000 - 0x001FFFFF : Data (.data, .bss)
0x00200000 - 0x002FFFFF : Heap (1MB)
0x00300000 - 0x0030FFFF : Stack (64KB)
0x00310000 - 0x08000000 : 未使用RAM
```

## 通信プロトコル

### 基本フォーマット

**Raspberry Pi → PC:**
```
[TaskSerial] Count: 123 | Uptime: 123 sec\r\n
[TaskProcess] Received: HELLO\r\n
```

**PC → Raspberry Pi:**
```
<メッセージ>\r\n
```

### メッセージ例

| 送信メッセージ | Raspberry Piの応答 |
|--------------|-------------------|
| HELLO | [TaskProcess] Received: HELLO |
| STATUS | [TaskProcess] Received: STATUS |
| TEST123 | [TaskProcess] Received: TEST123 |

## リアルタイム性能

### タスク応答時間

- **TaskSerial**: 1000ms ± 1ms（周期精度）
- **TaskBlink**: 500ms ± 1ms
- **TaskProcess**: 割り込み発生から約50μs以内に起動

### 割り込みレイテンシ

- **UART RX**: < 10μs（ハードウェア割り込み → ISR実行）

## 拡張性

### 追加可能な機能

1. **CANバス通信**
   - SPI-CANコントローラ追加
   - AUTOSAR CAN Driverの実装

2. **I2C/SPIセンサー連携**
   - センサードライバタスクの追加
   - 周期的なデータ収集

3. **ネットワーク通信**
   - Ethernet (LAN8720A)の追加
   - TCP/IPスタック統合

4. **マルチコア対応**
   - Cortex-A53の4コアを活用
   - タスク分散配置

5. **フラッシュストレージ**
   - SDカードI/O
   - ログ保存機能

## セーフティ機能

### エラー検出

- **ErrorHook**: AUTOSAR OSエラーをキャッチ
- **WatchdogTimer**: タスク監視（実装予定）

### デバッグ機能

- **UART経由ログ出力**
- **LED状態表示**
- **実行時統計情報**（実装予定）

## ビルド成果物

| ファイル | 説明 |
|---------|------|
| kernel.elf | ELFフォーマット実行ファイル |
| kernel.img | Raspberry Pi起動イメージ |
| *.o | オブジェクトファイル |

## 開発ガイドライン

### コーディング規約

- MISRA-C準拠（推奨）
- 関数名: snake_case
- マクロ: UPPER_CASE
- タスク名: PascalCase

### タスク追加手順

1. `app.oil`にタスク定義を追加
2. `app/main.c`にタスク実装を追加
3. 必要に応じてアラーム設定
4. リビルド・テスト

### デバッグ方法

1. **シリアル出力**: `uart_puts()` でログ出力
2. **LED点滅パターン**: エラー状態を視覚化
3. **JTAGデバッガ**: OpenOCD + GDB（上級者向け）

## ライセンス

- **本プロジェクト**: MIT License
- **Trampoline OS**: 独自ライセンス（要確認）
- **Python依存パッケージ**: 各パッケージのライセンスに従う
