/**
 * @file framebuffer.c
 * @brief Simple framebuffer driver for Raspberry Pi 4 HDMI output
 * 
 * This provides basic text console output to HDMI using mailbox property interface
 */

#include "framebuffer.h"
#include <stdint.h>

/* Mailbox peripheral base */
#if defined(RPI4)
    #define PERIPHERAL_BASE  0xFE000000
#elif defined(RPI3)
    #define PERIPHERAL_BASE  0x3F000000
#else
    #define PERIPHERAL_BASE  0x20000000
#endif

#define MAILBOX_BASE     (PERIPHERAL_BASE + 0xB880)
#define MAILBOX_READ     ((volatile uint32_t*)(MAILBOX_BASE + 0x00))
#define MAILBOX_STATUS   ((volatile uint32_t*)(MAILBOX_BASE + 0x18))
#define MAILBOX_WRITE    ((volatile uint32_t*)(MAILBOX_BASE + 0x20))

#define MAILBOX_EMPTY    0x40000000
#define MAILBOX_FULL     0x80000000

/* Screen configuration */
#define SCREEN_WIDTH     1024
#define SCREEN_HEIGHT    768
#define SCREEN_DEPTH     32

/* Font configuration (8x16 simple font) */
#define CHAR_WIDTH       8
#define CHAR_HEIGHT      16
#define COLS             (SCREEN_WIDTH / CHAR_WIDTH)
#define ROWS             (SCREEN_HEIGHT / CHAR_HEIGHT)

/* Framebuffer info */
static uint32_t fb_width = 0;
static uint32_t fb_height = 0;
static uint32_t fb_pitch = 0;
static uint32_t* fb_addr = 0;
static uint32_t cursor_x = 0;
static uint32_t cursor_y = 0;
static uint32_t text_color = 0xFFFFFFFF; /* White */

/* Mailbox message buffer (must be 16-byte aligned) */
static volatile uint32_t __attribute__((aligned(16))) mailbox[36];

/* Complete 8x16 font for ASCII 0x20-0x7E */
static const uint8_t font_8x16[128][16] = {
    [0x20] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* Space */
    [0x21] = {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00}, /* ! */
    [0x22] = {0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* " */
    [0x23] = {0x00, 0x00, 0x00, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00}, /* # */
    [0x24] = {0x00, 0x18, 0x18, 0x3E, 0x66, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x66, 0x7C, 0x18, 0x18, 0x00, 0x00}, /* $ */
    [0x25] = {0x00, 0x00, 0x00, 0x62, 0x66, 0x0C, 0x18, 0x30, 0x60, 0xC6, 0x86, 0x00, 0x00, 0x00, 0x00, 0x00}, /* % */
    [0x26] = {0x00, 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x70, 0xDE, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00}, /* & */
    [0x27] = {0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* ' */
    [0x28] = {0x00, 0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00}, /* ( */
    [0x29] = {0x00, 0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00}, /* ) */
    [0x2A] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* * */
    [0x2B] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* + */
    [0x2C] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00}, /* , */
    [0x2D] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* - */
    [0x2E] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00}, /* . */
    [0x2F] = {0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00}, /* / */
    [0x30] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* 0 */
    [0x31] = {0x00, 0x00, 0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00}, /* 1 */
    [0x32] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00}, /* 2 */
    [0x33] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x06, 0x1C, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* 3 */
    [0x34] = {0x00, 0x00, 0x0C, 0x1C, 0x2C, 0x4C, 0x4C, 0xCC, 0xFE, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00}, /* 4 */
    [0x35] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* 5 */
    [0x36] = {0x00, 0x00, 0x1C, 0x30, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* 6 */
    [0x37] = {0x00, 0x00, 0x7E, 0x66, 0x06, 0x0C, 0x0C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00}, /* 7 */
    [0x38] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* 8 */
    [0x39] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x0C, 0x38, 0x00, 0x00, 0x00, 0x00}, /* 9 */
    [0x3A] = {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}, /* : */
    [0x3B] = {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00}, /* ; */
    [0x3C] = {0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00}, /* < */
    [0x3D] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* = */
    [0x3E] = {0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00}, /* > */
    [0x3F] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x06, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00}, /* ? */
    [0x40] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x6E, 0x6E, 0x6E, 0x60, 0x62, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* @ */
    [0x41] = {0x00, 0x00, 0x18, 0x3C, 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* A */
    [0x42] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00}, /* B */
    [0x43] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x60, 0x60, 0x60, 0x60, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* C */
    [0x44] = {0x00, 0x00, 0x78, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00, 0x00, 0x00, 0x00}, /* D */
    [0x45] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00}, /* E */
    [0x46] = {0x00, 0x00, 0x7E, 0x60, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00}, /* F */
    [0x47] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x60, 0x60, 0x6E, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* G */
    [0x48] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* H */
    [0x49] = {0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* I */
    [0x4A] = {0x00, 0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x6C, 0x6C, 0x38, 0x00, 0x00, 0x00, 0x00}, /* J */
    [0x4B] = {0x00, 0x00, 0x66, 0x66, 0x6C, 0x6C, 0x78, 0x78, 0x6C, 0x6C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* K */
    [0x4C] = {0x00, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00}, /* L */
    [0x4D] = {0x00, 0x00, 0x63, 0x77, 0x7F, 0x6B, 0x6B, 0x63, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00}, /* M */
    [0x4E] = {0x00, 0x00, 0x66, 0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* N */
    [0x4F] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* O */
    [0x50] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00}, /* P */
    [0x51] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6E, 0x6C, 0x3C, 0x06, 0x00, 0x00, 0x00}, /* Q */
    [0x52] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* R */
    [0x53] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* S */
    [0x54] = {0x00, 0x00, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00}, /* T */
    [0x55] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* U */
    [0x56] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00}, /* V */
    [0x57] = {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x6B, 0x6B, 0x6B, 0x7F, 0x77, 0x63, 0x00, 0x00, 0x00, 0x00}, /* W */
    [0x58] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* X */
    [0x59] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00}, /* Y */
    [0x5A] = {0x00, 0x00, 0x7E, 0x06, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00}, /* Z */
    [0x5B] = {0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* [ */
    [0x5C] = {0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00}, /* \ */
    [0x5D] = {0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* ] */
    [0x5E] = {0x00, 0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* ^ */
    [0x5F] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00}, /* _ */
    [0x60] = {0x00, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* ` */
    [0x61] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00}, /* a */
    [0x62] = {0x00, 0x00, 0x60, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00}, /* b */
    [0x63] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* c */
    [0x64] = {0x00, 0x00, 0x06, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00}, /* d */
    [0x65] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x7E, 0x60, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* e */
    [0x66] = {0x00, 0x00, 0x1C, 0x36, 0x30, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00, 0x00, 0x00, 0x00}, /* f */
    [0x67] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x66, 0x3C, 0x00, 0x00}, /* g */
    [0x68] = {0x00, 0x00, 0x60, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* h */
    [0x69] = {0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* i */
    [0x6A] = {0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x3C, 0x00, 0x00}, /* j */
    [0x6B] = {0x00, 0x00, 0x60, 0x60, 0x60, 0x66, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* k */
    [0x6C] = {0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* l */
    [0x6D] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x6C, 0xFE, 0xD6, 0xD6, 0xD6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00}, /* m */
    [0x6E] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* n */
    [0x6F] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* o */
    [0x70] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00, 0x00}, /* p */
    [0x71] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x06, 0x00, 0x00}, /* q */
    [0x72] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00}, /* r */
    [0x73] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00}, /* s */
    [0x74] = {0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00}, /* t */
    [0x75] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00}, /* u */
    [0x76] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00}, /* v */
    [0x77] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xD6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00, 0x00, 0x00, 0x00}, /* w */
    [0x78] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00}, /* x */
    [0x79] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x66, 0x3C, 0x00, 0x00, 0x00}, /* y */
    [0x7A] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00}, /* z */
    [0x7B] = {0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18, 0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00}, /* { */
    [0x7C] = {0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00}, /* | */
    [0x7D] = {0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00}, /* } */
    [0x7E] = {0x00, 0x00, 0x00, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /* ~ */
};

/* Mailbox operations */
static void mailbox_write(uint32_t channel, uint32_t data) {
    while (*MAILBOX_STATUS & MAILBOX_FULL);
    *MAILBOX_WRITE = (data & 0xFFFFFFF0) | (channel & 0xF);
}

static uint32_t mailbox_read(uint32_t channel) {
    uint32_t data;
    while (1) {
        while (*MAILBOX_STATUS & MAILBOX_EMPTY);
        data = *MAILBOX_READ;
        if ((data & 0xF) == channel) {
            return data & 0xFFFFFFF0;
        }
    }
}

/* Initialize framebuffer */
int fb_init(void) {
    /* Setup mailbox message */
    mailbox[0] = 35 * 4;              /* Total size */
    mailbox[1] = 0;                   /* Request code */
    
    /* Set physical display size */
    mailbox[2] = 0x48003;             /* Tag: Set physical width/height */
    mailbox[3] = 8;                   /* Value buffer size */
    mailbox[4] = 8;                   /* Request size */
    mailbox[5] = SCREEN_WIDTH;        /* Width */
    mailbox[6] = SCREEN_HEIGHT;       /* Height */
    
    /* Set virtual display size */
    mailbox[7] = 0x48004;             /* Tag: Set virtual width/height */
    mailbox[8] = 8;
    mailbox[9] = 8;
    mailbox[10] = SCREEN_WIDTH;
    mailbox[11] = SCREEN_HEIGHT;
    
    /* Set depth */
    mailbox[12] = 0x48005;            /* Tag: Set depth */
    mailbox[13] = 4;
    mailbox[14] = 4;
    mailbox[15] = SCREEN_DEPTH;
    
    /* Allocate framebuffer */
    mailbox[16] = 0x40001;            /* Tag: Allocate buffer */
    mailbox[17] = 8;
    mailbox[18] = 8;
    mailbox[19] = 16;                 /* Alignment */
    mailbox[20] = 0;
    
    /* Get pitch */
    mailbox[21] = 0x40008;            /* Tag: Get pitch */
    mailbox[22] = 4;
    mailbox[23] = 4;
    mailbox[24] = 0;
    
    mailbox[25] = 0;                  /* End tag */
    
    /* Send message */
    mailbox_write(8, (uint32_t)((uintptr_t)mailbox));
    mailbox_read(8);
    
    /* Check response */
    if (mailbox[1] != 0x80000000) {
        return -1;  /* Error */
    }
    
    /* Get framebuffer info */
    fb_width = mailbox[5];
    fb_height = mailbox[6];
    fb_addr = (uint32_t*)(uintptr_t)(mailbox[19] & 0x3FFFFFFF);
    fb_pitch = mailbox[24];
    
    cursor_x = 0;
    cursor_y = 0;
    
    /* Clear screen */
    fb_clear();
    
    return 0;
}

/* Draw a character at current position */
static void draw_char(char c, uint32_t x, uint32_t y) {
    const uint8_t* glyph = font_8x16[(uint8_t)c];
    
    for (int row = 0; row < CHAR_HEIGHT; row++) {
        uint8_t line = glyph[row];
        for (int col = 0; col < CHAR_WIDTH; col++) {
            if (line & (0x80 >> col)) {
                uint32_t pixel_x = x * CHAR_WIDTH + col;
                uint32_t pixel_y = y * CHAR_HEIGHT + row;
                if (pixel_x < fb_width && pixel_y < fb_height) {
                    fb_addr[pixel_y * (fb_pitch / 4) + pixel_x] = text_color;
                }
            }
        }
    }
}

/* Scroll screen up by one line */
static void scroll_up(void) {
    /* Move all lines up */
    for (uint32_t y = CHAR_HEIGHT; y < fb_height; y++) {
        for (uint32_t x = 0; x < fb_width; x++) {
            uint32_t src_idx = y * (fb_pitch / 4) + x;
            uint32_t dst_idx = (y - CHAR_HEIGHT) * (fb_pitch / 4) + x;
            fb_addr[dst_idx] = fb_addr[src_idx];
        }
    }
    
    /* Clear last line */
    for (uint32_t y = fb_height - CHAR_HEIGHT; y < fb_height; y++) {
        for (uint32_t x = 0; x < fb_width; x++) {
            fb_addr[y * (fb_pitch / 4) + x] = 0;
        }
    }
}

/* Print character */
void fb_putc(char c) {
    if (!fb_addr) return;
    
    if (c == '\n') {
        cursor_x = 0;
        cursor_y++;
    } else if (c == '\r') {
        cursor_x = 0;
    } else {
        draw_char(c, cursor_x, cursor_y);
        cursor_x++;
        if (cursor_x >= COLS) {
            cursor_x = 0;
            cursor_y++;
        }
    }
    
    if (cursor_y >= ROWS) {
        scroll_up();
        cursor_y = ROWS - 1;
    }
}

/* Print string */
void fb_puts(const char* str) {
    while (*str) {
        fb_putc(*str++);
    }
}

/* Print hex value */
void fb_put_hex(uint32_t value) {
    const char hex[] = "0123456789ABCDEF";
    fb_puts("0x");
    for (int i = 28; i >= 0; i -= 4) {
        fb_putc(hex[(value >> i) & 0xF]);
    }
}

/* Print decimal value */
void fb_put_dec(uint32_t value) {
    char buffer[11];
    int i = 0;
    
    if (value == 0) {
        fb_putc('0');
        return;
    }
    
    while (value > 0) {
        buffer[i++] = '0' + (value % 10);
        value /= 10;
    }
    
    while (i > 0) {
        fb_putc(buffer[--i]);
    }
}

/* Clear screen */
void fb_clear(void) {
    if (!fb_addr) return;
    
    for (uint32_t i = 0; i < (fb_height * fb_pitch / 4); i++) {
        fb_addr[i] = 0;
    }
    
    cursor_x = 0;
    cursor_y = 0;
}

/* Set text color */
void fb_set_color(uint8_t r, uint8_t g, uint8_t b) {
    text_color = (0xFF << 24) | (r << 16) | (g << 8) | b;
}
